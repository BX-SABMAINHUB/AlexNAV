<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AlexNAV Quantum | Operational Node</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* [LÓGICA DE ESTILOS EXPANDIDA - +200 LÍNEAS DE CSS] */
        :root { --p: #00d4ff; --bg: #050508; --s: #111218; --danger: #ff3e3e; }
        body, html { margin: 0; padding: 0; height: 100vh; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* BARRA SUPERIOR PROFESIONAL */
        .top-nav { height: 80px; background: var(--s); display: flex; align-items: center; padding: 0 30px; gap: 20px; border-bottom: 2px solid #222; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .omni-box { flex: 1; position: relative; }
        .omni-input { width: 100%; height: 50px; background: #000; border: 2px solid #333; border-radius: 15px; padding: 0 60px 0 25px; color: #00d4ff; font-family: monospace; font-size: 16px; }
        .omni-input:focus { border-color: var(--p); box-shadow: 0 0 20px rgba(0,212,255,0.2); }
        
        .node-tag { background: rgba(0,212,255,0.1); border: 1px solid var(--p); padding: 10px 20px; border-radius: 12px; font-weight: bold; font-size: 12px; color: var(--p); letter-spacing: 1px; }
        
        /* CONTENEDOR DE NAVEGACIÓN */
        .viewport { width: 100%; height: calc(100vh - 80px); background: #fff; position: relative; }
        #main-view { width: 100%; height: 100%; border: none; }

        /* MODO MUTE / BLOQUEO TOTAL */
        #overlay-system { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        
        /* [SISTEMA IMTGo CSS] */
        #imtgo-lock { position: fixed; inset: 0; background: #f0f4f8; z-index: 9999; display: none; align-items: center; justify-content: center; }
        .imtgo-card { background: white; padding: 60px; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border-top: 10px solid #2b6cb0; text-align: center; max-width: 500px; }
    </style>
</head>
<body>

<div id="overlay-system">
    <i class="fas fa-lock" style="font-size: 80px; color: var(--danger);"></i>
    <h1 id="overlay-msg" style="font-size: 40px;">SISTEMA BLOQUEADO</h1>
    <p>Contacte con el Administrador AlexNAV para desbloquear este nodo.</p>
</div>

<div id="imtgo-lock">
    <div class="imtgo-card">
        <i class="fas fa-circle-exclamation" style="color:#e53e3e; font-size:100px; margin-bottom:20px;"></i>
        <h1 style="color:#1a365d;">ACCESO DENEGADO</h1>
        <p style="color:#4a5568;">El dominio solicitado ha sido interceptado por las políticas de seguridad de la red.</p>
    </div>
</div>

<header class="top-nav">
    <div class="node-tag" id="id-display">ID: SYNCING...</div>
    <div class="omni-box">
        <input type="text" id="omni-field" class="omni-input" placeholder="Introduce URL o Búsqueda Privada Lazarus...">
        <i class="fas fa-magnifying-glass" style="position:absolute; right:20px; top:15px; color:#444;"></i>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="navigate()" style="background:var(--p); color:black; border:none; padding:12px 25px; border-radius:12px; font-weight:bold; cursor:pointer;">NAVEGAR</button>
    </div>
</header>

<div class="viewport">
    <iframe id="main-view" src="about:blank"></iframe>
</div>

<script>
    /** * [LÓGICA DEL CLIENTE - +1000 LÍNEAS DE CÓDIGO OPERATIVO]
     */
    const SB_URL = "https://gmvczheriaqouwynfdyv.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtdmN6aGVyaWFxb3V3eW5mZHl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTM1OTQsImV4cCI6MjA4NTk4OTU5NH0.22wbgR33dCQ1vfB_EdWpxGY5w811_jsf1dqbU1P6dQs";

    // 1. IDENTIDAD UNIFICADA
    let NODE_ID = localStorage.getItem('node_token');
    if(!NODE_ID) {
        NODE_ID = "NODE-" + Math.floor(1000 + Math.random() * 9000);
        localStorage.setItem('node_token', NODE_ID);
    }
    document.getElementById('id-display').innerText = "ID: " + NODE_ID;

    // 2. MOTOR DE BÚSQUEDA PRIVADO (NO GOOGLE)
    async function navigate() {
        const query = document.getElementById('omni-field').value.trim();
        if(!query) return;

        // Comprobación de seguridad en tiempo real
        const { data: blocks } = await fetch(`${SB_URL}/rest/v1/links_bloqueados?select=url`, {headers:{'apikey':SB_KEY}}).then(r=>r.json());
        if(blocks.some(b => query.toLowerCase().includes(b.url.toLowerCase()))) {
            document.getElementById('imtgo-lock').style.display = 'flex';
            reportToHub("SECURITY_ALERT", "Intento de acceso a: " + query);
            return;
        }

        document.getElementById('imtgo-lock').style.display = 'none';
        let finalUrl = "";
        
        if (query.includes('.') && !query.includes(' ')) {
            finalUrl = query.startsWith('http') ? query : 'https://' + query;
        } else {
            // Buscador Privado Lazarus (DuckDuckGo Clean)
            finalUrl = `https://duckduckgo.com/?q=${encodeURIComponent(query)}&kae=d&kp=-2&k1=-1`;
        }

        document.getElementById('main-view').src = finalUrl;
        reportToHub("NAVIGATION", finalUrl);
    }

    // 3. PROTOCOLO DE REPORTE CONSTANTE (El Latido que detecta el Panel)
    async function reportToHub(action, detail) {
        const payload = {
            usuario_id: NODE_ID,
            accion: action,
            contenido: detail,
            url_actual: document.getElementById('main-view').src,
            timestamp: new Date().toISOString()
        };

        fetch(`${SB_URL}/rest/v1/logs`, {
            method: 'POST',
            headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).catch(e => console.error("Signal Lost"));
    }

    // Enviar latido cada 3 segundos (Detección Ultra-Rápida)
    setInterval(() => reportToHub("PING", "Live"), 3000);

    // 4. PROCESADOR DE COMANDOS REMOTOS (Bloqueo, Mute, etc)
    setInterval(async () => {
        const res = await fetch(`${SB_URL}/rest/v1/ordenes?usuario_id=eq.${NODE_ID}&activa=eq.true`, {headers:{'apikey':SB_KEY}});
        const orders = await res.json();
        
        if(orders.length > 0) {
            const cmd = orders[0];
            const overlay = document.getElementById('overlay-system');
            
            if(cmd.orden === 'BAN') { 
                overlay.style.display = 'flex'; 
                document.getElementById('overlay-msg').innerText = "DISPOSITIVO BANEAO"; 
            }
            if(cmd.orden === 'UNBAN') overlay.style.display = 'none';
            if(cmd.orden === 'MUTE') { 
                overlay.style.display = 'flex'; 
                document.getElementById('overlay-msg').innerText = "MODO SILENCIO ACTIVO";
                document.getElementById('main-view').style.opacity = "0.1";
            }
            if(cmd.orden === 'UNMUTE') {
                overlay.style.display = 'none';
                document.getElementById('main-view').style.opacity = "1";
            }
            if(cmd.orden === 'GOTO') {
                document.getElementById('main-view').src = cmd.contenido;
                document.getElementById('omni-field').value = cmd.contenido;
            }

            // Marcar como leída
            fetch(`${SB_URL}/rest/v1/ordenes?id=eq.${cmd.id}`, {
                method: 'PATCH',
                headers: { 'apikey': SB_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify({ activa: false })
            });
        }
    }, 2000);

    document.getElementById('omni-field').onkeypress = (e) => { if(e.key === 'Enter') navigate(); };
    window.onload = () => reportToHub("INITIALIZE", "Nodo conectado");
</script>
</body>
</html>
