<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlexNAV Quantum</title>
    <style>
        :root { --main: #00d4ff; --bg: #050505; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        /* HEADER ESTILO PREMIUM */
        header { 
            height: 60px; background: #111; display: flex; align-items: center; 
            padding: 0 20px; border-bottom: 1px solid #333; gap: 15px;
        }
        .logo { font-weight: 900; color: var(--main); letter-spacing: -1px; font-size: 1.2rem; cursor: pointer; }
        .omni-bar { 
            flex: 1; background: #1a1a1a; border: 1px solid #333; 
            color: white; padding: 10px 15px; border-radius: 10px; outline: none;
            transition: 0.3s; font-size: 14px;
        }
        .omni-bar:focus { border-color: var(--main); background: #222; }

        /* CONTENEDOR DE WEB */
        #web-viewport { width: 100%; height: calc(100vh - 61px); border: none; background: white; }

        /* PANTALLAS DE CONTROL (OCULTAS POR DEFECTO) */
        .overlay { 
            position: fixed; inset: 0; display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 99999; 
            text-align: center; font-family: monospace; padding: 20px;
        }
        #block-screen { background: #8b0000; color: white; }
        #mute-screen { background: #000; color: #00ff41; }
        #link-screen { background: #4a0000; color: white; }
        .timer { font-size: 4rem; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="block-screen" class="overlay">
    <h1 style="font-size: 3rem;">BLOQUEADO POR ALEX</h1>
    <p style="font-size: 1.2rem;">ACCESO RESTRINGIDO POR EL ADMINISTRADOR</p>
</div>

<div id="mute-screen" class="overlay">
    <h1>SISTEMA EN PAUSA</h1>
    <p>TIEMPO DE ESPERA ASIGNADO:</p>
    <div id="mute-timer" class="timer">00:00</div>
</div>

<div id="link-screen" class="overlay">
    <h1 style="font-size: 2.5rem;">LINK INVÁLIDO</h1>
    <p>ESTE DOMINIO ESTÁ EN LA LISTA NEGRA DE ALEXNAV</p>
    <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; cursor:pointer;">REGRESAR</button>
</div>

<header>
    <div class="logo" onclick="location.reload()">ALEXNAV</div>
    <input type="text" id="omni-in" class="omni-bar" placeholder="Busca o escribe una URL (ej: google.com)" onkeypress="if(event.key==='Enter') ejecutarNavegacion()">
</header>

<iframe id="web-viewport" src="about:blank"></iframe>

<script>
    // --- CONFIGURACIÓN ---
    const SB_URL = "https://gmvczheriaqouwynfdyv.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtdmN6aGVyaWFxb3V3eW5mZHl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTM1OTQsImV4cCI6MjA4NTk4OTU5NH0.22wbgR33dCQ1vfB_EdWpxGY5w811_jsf1dqbU1P6dQs";

    // --- DETECCIÓN DE DISPOSITIVO ---
    function getDevice() {
        const ua = navigator.userAgent;
        if (/tablet|ipad|playbook|silk/i.test(ua)) return "Tablet";
        if (/Mobile|Android|iP(hone|od)/i.test(ua)) return "Smartphone";
        return "PC-Desktop";
    }
    const USER_ID = getDevice() + "_" + Math.floor(Math.random() * 899 + 100);
    let muteInterval;

    // --- MOTOR DE NAVEGACIÓN ---
    async function ejecutarNavegacion() {
        const input = document.getElementById('omni-in');
        const query = input.value.trim().toLowerCase();
        if(!query) return;

        // 1. Verificar Links Bloqueados en Supabase
        try {
            const res = await fetch(`${SB_URL}/rest/v1/links_bloqueados?select=url`, {
                headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
            });
            const prohibidos = await res.json();
            if (prohibidos.some(item => query.includes(item.url))) {
                document.getElementById('link-screen').style.display = 'flex';
                reportar("INTENTO_PROHIBIDO", query);
                return;
            }
        } catch(e) { console.log("Error checking blacklist"); }

        // 2. Procesar URL
        let destino = "";
        if (query.includes('.') && !query.includes(' ')) {
            destino = query.startsWith('http') ? query : 'https://' + query;
        } else {
            destino = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        }

        document.getElementById('web-viewport').src = destino;
        reportar("NAVEGACION", destino);
    }

    // --- SISTEMA DE REPORTE SILENCIOSO ---
    async function reportar(accion, detalle) {
        try {
            await fetch(`${SB_URL}/rest/v1/logs`, {
                method: 'POST',
                headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usuario_id: USER_ID,
                    accion: accion,
                    contenido: detalle,
                    url_actual: document.getElementById('web-viewport').src
                })
            });
        } catch(e) {}
    }

    // --- RECEPTOR DE COMANDOS REMOTOS ---
    setInterval(async () => {
        try {
            const res = await fetch(`${SB_URL}/rest/v1/ordenes?usuario_id=eq.${USER_ID}&activa=eq.true`, {
                headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
            });
            const ordenes = await res.json();
            
            if (ordenes.length > 0) {
                const cmd = ordenes[0];
                if (cmd.orden === 'BLOQUEAR') document.getElementById('block-screen').style.display = 'flex';
                if (cmd.orden === 'MUTE') activarMute(cmd.minutos);
                if (cmd.orden === 'LIBERAR') {
                    document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
                    clearInterval(muteInterval);
                }
            }
        } catch(e) {}
    }, 3000);

    function activarMute(m) {
        let segs = m * 60;
        const display = document.getElementById('mute-timer');
        document.getElementById('mute-screen').style.display = 'flex';
        clearInterval(muteInterval);
        muteInterval = setInterval(() => {
            let min = Math.floor(segs / 60);
            let s = segs % 60;
            display.innerText = `${min}:${s < 10 ? '0' : ''}${s}`;
            if (--segs < 0) {
                document.getElementById('mute-screen').style.display = 'none';
                clearInterval(muteInterval);
            }
        }, 1000);
    }
</script>
</body>
</html>
